
import os
import base64
from flask import Flask, render_template, request, redirect, url_for, jsonify
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager, UserMixin, login_user, login_required, logout_user, current_user
from werkzeug.security import generate_password_hash, check_password_hash
from flask_migrate import Migrate
from datetime import datetime, timedelta
from email.mime.text import MIMEText

# Gmail API imports
from google.oauth2.credentials import Credentials
from google_auth_oauthlib.flow import InstalledAppFlow
from googleapiclient.discovery import build

# Gmail API scope
SCOPES = ['httpswww.googleapis.comauthgmail.send']

# Flask app setup
app = Flask(__name__)
app.config['SECRET_KEY'] = 'your_secret_key'
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlitedb.sqlite'
db = SQLAlchemy(app)
migrate = Migrate(app, db)

login_manager = LoginManager()
login_manager.init_app(app)
login_manager.login_view = 'login'

# Role durations
role_durations = {
    Researcher timedelta(days=120),
    PhD timedelta(days=90),
    Master timedelta(days=150),
    Short term timedelta(days=14)
}

# Models
class User(UserMixin, db.Model)
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(150), unique=True)
    password = db.Column(db.String(150))
    role = db.Column(db.String(50), default='user')

class Request(db.Model)
    id = db.Column(db.Integer, primary_key=True)
    timestamp = db.Column(db.DateTime, default=datetime.utcnow)
    name = db.Column(db.String(100))
    role = db.Column(db.String(50))
    start_time = db.Column(db.String(50))
    end_time = db.Column(db.String(50))
    status = db.Column(db.String(50), default=Pending)
    workstation = db.Column(db.String(50))
    renewals = db.Column(db.Integer)

@login_manager.user_loader
def load_user(user_id)
    return User.query.get(int(user_id))

# Gmail API helper
def get_gmail_service()
    creds = None
    token_path = 'token.json'
    credentials_path = 'credentials.json'

    if os.path.exists(token_path)
        creds = Credentials.from_authorized_user_file(token_path, SCOPES)

    if not creds or not creds.valid
        if creds and creds.expired and creds.refresh_token
            creds.refresh(Request())
        else
            flow = InstalledAppFlow.from_client_secrets_file(credentials_path, SCOPES)
            creds = flow.run_local_server(port=0)
        with open(token_path, 'w') as token_file
            token_file.write(creds.to_json())

    return build('gmail', 'v1', credentials=creds)

# Email sending function using Gmail API
def send_email(name, role, start_time, end_time, status)
    service = get_gmail_service()
    sender = 'your_email@gmail.com'
    receiver = 'maugut@kth.se'
    subject = New Workstation Request Submitted
    body = f
    A new workstation request has been submitted
    Name {name}
    Role {role}
    Start Time {start_time}
    End Time {end_time}
    Status {status}
    

    message = MIMEText(body)
    message['to'] = receiver
    message['from'] = sender
    message['subject'] = subject

    raw_message = base64.urlsafe_b64encode(message.as_bytes()).decode()

    try
        service.users().messages().send(userId='me', body={'raw' raw_message}).execute()
        print(Email sent successfully via Gmail API)
    except Exception as e
        print(fEmail sending failed {e})
        return jsonify({'status' 'email_failed'})

# Routes remain unchanged except email sending now uses Gmail API
@app.route('')
@login_required
def dashboard()
    Request.query.filter_by(status='Completed').delete()
    db.session.commit()
    pending_requests = Request.query.filter_by(status='Pending').order_by(Request.role.asc(), Request.timestamp.asc()).all()
    running_requests = Request.query.filter_by(status='Running').order_by(Request.role.asc(), Request.timestamp.asc()).all()
    chart_data = []
    for req in running_requests
        chart_data.append({
            name req.name or ,
            workstation req.workstation or ,
            start str(req.start_time),
            end str(req.end_time),
            renewals req.renewals or ,
            color blue if req.role == PhD else orange if req.role == Master else green
        })
    return render_template('dashboard.html', pending_requests=pending_requests, running_requests=running_requests, chart_data=chart_data)

@app.route('submit', methods=['POST'])
@login_required
def submit()
    data = request.get_json()
    name = data['name']
    role = data['role']
    start_time = data['startTime']
    end_time = data['endTime']

    try
        start_dt = datetime.strptime(start_time, %Y-%m-%d)
        end_dt = datetime.strptime(end_time, %Y-%m-%d)
        max_duration = role_durations.get(role, timedelta(days=60))
        if end_dt - start_dt  max_duration
            end_dt = start_dt + max_duration
            end_time = end_dt.strftime(%Y-%m-%d)
    except Exception as e
        print(fDate parsing error {e})

    new_request = Request(name=name, role=role, start_time=start_time, end_time=end_time)
    db.session.add(new_request)
    db.session.commit()

    # Send email via Gmail API
    send_email(new_request.name, new_request.role, new_request.start_time, new_request.end_time, new_request.status)

    return jsonify({'status' 'success'})

# Other routes (login, logout, admin dashboard, update_status) remain unchanged

if __name__ == '__main__'
    with app.app_context()
        db.create_all()
        if not User.query.filter_by(username='admin').first()
            admin_pw = generate_password_hash('secret123', method='pbkdf2sha256')
            admin_user = User(username='admin', password=admin_pw, role='admin')
            db.session.add(admin_user)
        if not User.query.filter_by(username='hpt').first()
            hpt_pw = generate_password_hash('hpt', method='pbkdf2sha256')
            hpt_user = User(username='hpt', password=hpt_pw, role='user')
            db.session.add(hpt_user)
        db.session.commit()
    app.run(debug=False, use_reloader=False)
